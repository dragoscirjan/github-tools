name: Test Artefact Actions (Docker)

on:
  workflow_dispatch:
  workflow_call:
  push:
    branches:
      - main
  pull_request:

jobs:
  test-artefact-actions:
    runs-on: ubuntu-latest
    services:
      htpasswd:
        image: httpd:2.4-alpine
        options: >-
          --health-cmd="htpasswd -Bbn testuser testpassword > /auth/htpasswd"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20
        volumes:
          - /tmp/registry/auth:/auth
      registry:
        image: registry:2
        env:
          REGISTRY_AUTH: htpasswd
          REGISTRY_AUTH_HTPASSWD_REALM: "Registry Realm"
          REGISTRY_AUTH_HTPASSWD_PATH: /auth/htpasswd
        options: >-
          --health-cmd="if ! command -v curl; then apk add curl; fi; curl -u 'testuser:testpassword' http://localhost:5000/v2/ || exit 1"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=20
        ports:
          - 5000:5000
        volumes:
          - /tmp/registry/auth:/auth
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Prepare docker test image
        run: |
          docker pull alpine:latest
          docker tag alpine:latest localhost:5000/alpine:latest

      - name: Docker Login
        uses: docker/login-action@v3
        with:
          registry: localhost:5000
          username: testuser
          password: testpassword

      - name: Build and push to local registry
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: localhost:5000/alpine:latest

      - name: Configure MinIO
        run: |
          docker image rm alpine localhost:5000/alpine

      - name: Build Test Artefact
        run: |
          echo "This is a test artefact" > test-artefact.txt

      # - name: Test Artefact Push to S3 (MinIO)
      #   uses: ./.github/actions/artefact-push
      #   with:
      #     to: s3://test-bucket
      #     artefact: test-artefact.txt
      #     version: v1.0.0
      #     aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
      #     aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
      #     aws-region: ${{ env.AWS_REGION }}
      #     no-aws-auth: true  # Since MinIO accepts any credentials

      # - name: Verify Artefact in MinIO
      #   run: |
      #     mc ls myminio/test-bucket/v1.0.0/

      # - name: Test Artefact Pull from S3 (MinIO)
      #   uses: ./.github/actions/artefact-pull
      #   with:
      #     from: s3://test-bucket
      #     artefact: test-artefact.txt
      #     version: v1.0.0
      #     aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
      #     aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
      #     aws-region: ${{ env.AWS_REGION }}
      #     no-aws-auth: true

      # - name: Verify Pulled Artefact
      #   run: |
      #     cat test-artefact.txt

      # - name: Build Docker Image
      #   run: |
      #     echo -e "FROM alpine\nCMD echo 'Hello World'" > Dockerfile
      #     docker build -t localhost:5000/test-image:latest .

      # - name: Test Docker Push to Local Registry
      #   uses: ./.github/actions/artefact-push
      #   with:
      #     to: docker://localhost:5000/test-image
      #     version: latest
      #     artefact: Dockerfile  # Not used, but required
      #     jfrog-user: dummy  # Not used for local registry
      #     jfrog-pass: dummy

      # - name: Verify Docker Image in Registry
      #   run: |
      #     curl -X GET http://localhost:5000/v2/_catalog

      # - name: Test Docker Pull from Local Registry
      #   uses: ./.github/actions/artefact-pull
      #   with:
      #     from: docker://localhost:5000/test-image
      #     version: latest
      #     artefact: Dockerfile  # Not used, but required
      #     jfrog-user: dummy  # Not used for local registry
      #     jfrog-pass: dummy

      # - name: Cleanup
      #   if: ${{ always() }}
      #   run: |
      #     docker rmi localhost:5000/test-image:latest || true
      #     mc rb --force myminio/test-bucket
