name: Test Artefact Actions (S3)

on:
  workflow_dispatch:
  workflow_call:
  push:
    branches:
      - main
  pull_request:

jobs:
  test-artefact-actions:
    runs-on: ubuntu-latest
    # services:
    #   minio:
    #     image: minio/minio:latest
    #     ports:
    #       - 9000:9000
    #     env:
    #       MINIO_ROOT_USER: minioadmin
    #       MINIO_ROOT_PASSWORD: minioadmin
    #     options: >-
    #       --health-cmd "curl --fail http://localhost:9000/minio/health/live || exit 1"
    #       --health-interval 10s
    #       --health-timeout 5s
    #       --health-retries 3
    #       --entrypoint "minio server /data"
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Launch MinIO
        run: |
          docker run --rm -e MINIO_ROOT_USER=minioadmin -e MINIO_ROOT_PASSWORD=minioadmin -p 9000:9000 \
            -d minio/minio:latest minio server /data

      - name: Wait for MinIO to be ready
        run: |
          for i in {1..30}; do
            curl -s http://localhost:9000/minio/health/live && echo "MinIO is ready" && exit 0
            echo "Waiting for MinIO..."
            sleep 5
          done
          echo "MinIO did not become ready in time"
          exit 1

      # - name: Install Oras
      #   uses: dragoscirjan/github-tools/.github/actions/oras-setup@main
      #
      # - name: Create Artefact
      #   run: |
      #     echo "hello world" > artefact.txt
      #
      # - name: Test Oras Push to ${{ matrix.registry }}-test
      #   if: ${{ ! contains(matrix.registry, 'ecr://') }}
      #   run: |
      #     registry="${{ matrix.registry }}-test"
      #     registry_path=${registry#oci://}
      #     registry_host=${registry_path%%/*}
      #
      #     oras login $registry_host \
      #       --username ${{ matrix.username }} \
      #       --password ${{ matrix.password }}
      #
      #     oras push $registry_path:0.1.0 ./artefact.txt
      #
      # - name: Test Artefact Push to ${{ matrix.registry }}
      #   uses: ./.github/actions/artefact-push
      #   with:
      #     to: ${{ matrix.registry }}
      #     artefact: artefact.txt
      #     version: 0.1.0
      #     username: ${{ matrix.username }}
      #     password: ${{ matrix.password }}
